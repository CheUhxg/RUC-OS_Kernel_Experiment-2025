#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <string.h>

#define CODE_SIZE 4096

int main() {
    printf("Malware process started. PID: %d\n", getpid());

    // mmap 一个额外可执行段，用于加载恶意代码
    void *exec_buf = mmap(NULL, CODE_SIZE,
                          PROT_READ | PROT_WRITE | PROT_EXEC,
                          MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    if (exec_buf == MAP_FAILED) {
        perror("mmap");
        return 1;
    }

    memset(exec_buf, 0x90, CODE_SIZE);  // 填充 NOP

    printf("Extra executable VMA mapped at %p\n", exec_buf);
    printf("Use: cat /proc/%d/maps to check VMA before and after loading the kernel module.\n", getpid());

    // 模拟 payload / 保持活动状态
    for (int i = 60; i > 0; --i) {
        sleep(1);
    }

    printf("Malware process exiting.\n");
    return 0;
}
